{% extends 'base.html'%}
{% block content %}
<h1>ChattyDChat Chatsite</h1>
<div class="container">
    <div class="room-members">
        <h3>Online Members:</h3>
        <ul id="online-members"></ul>
    </div>
    <div class="message-box" id="message-box">
        <h2>Chat Room: {{code}}</h2>
        <div class="messages" id="messages"></div>
        <div class="inputs">
            <input type="text" name="message" id="message" row="3" placeholder="Type message">
            <button type="button" name="send" id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>
<script type="text/javascript">
    let socketio = io();

    const messages = document.getElementById("messages");
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send-btn');

    const createMessage = (name, msg) => {
        const content = `
        <div class="text">
            <span>
                <strong>${name}</strong>: ${msg}
            </span>
            <span class="muted">
                now
            </span>
        </div>
        `;
        messages.innerHTML += content;
        scrollToBottom();
    };

    socketio.on("message", (data) => {
        createMessage(data.name, data.message);
    });

    socketio.on("online_members", (onlineMembers) => {
        const onlineMembersList = document.getElementById("online-members");
        onlineMembersList.innerHTML = ""; // Clear the existing list

        onlineMembers.forEach((member) => {
            const listItem = document.createElement(`
            <li>${member}</li>
            `);
            listItem.textContent = member;
            onlineMembersList.appendChild(listItem);
        });
    });


    const sendMessage = () => {
        const message = document.getElementById("message");
        if (message.value == "") return;
        socketio.emit("message", {
            data: message.value
        });
        message.value = "";
    };

    // Listen for keypress event on the input field
    messageInput.addEventListener('keypress', function(event) {
      if (event.keyCode === 13) { // Enter key code is 13
        event.preventDefault(); // Prevent line break
        sendMessage(); // Call the sendMessage function
      }
    });

    // Listen for click event on the send button
    sendButton.addEventListener('click', sendMessage);

    const scrollToBottom = () => {
        messages.scrollTop = messages.scrollHeight;
    };

    window.addEventListener("load", scrollToBottom);
</script>
{% for msg in messages %}
<script type="text/javascript">
    createMessage("{{msg.name}}", "{{msg.message}}");
</script>
{% endfor %}
{% endblock %}